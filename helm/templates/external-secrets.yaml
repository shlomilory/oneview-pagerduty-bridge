{{- if .Values.externalSecrets.enabled }}
{{- if .Values.externalSecrets.secretStore.enabled }}
---
{{- if semverCompare ">=1.31-0" $.Capabilities.KubeVersion.Version }}
apiVersion: external-secrets.io/v1
{{- else }}
apiVersion: external-secrets.io/v1beta1
{{- end }}
kind: SecretStore
metadata:
  name: {{ .Values.externalSecrets.secretStore.name | default (printf "%s-secretstore" (include "oneview-pagerduty-bridge.fullname" .)) }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "oneview-pagerduty-bridge.labels" . | nindent 4 }}
    component: external-secrets
    {{- with .Values.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .Values.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  provider:
    vault:
      server: {{ .Values.externalSecrets.secretStore.vault.server | quote }}
      path: {{ .Values.externalSecrets.secretStore.vault.path | quote }}
      version: {{ .Values.externalSecrets.secretStore.vault.version | quote }}
      auth:
        {{- if eq .Values.externalSecrets.secretStore.vault.auth.method "kubernetes" }}
        {{- with .Values.externalSecrets.secretStore.vault.auth.kubernetes }}
        kubernetes:
          mountPath: {{ .mountPath | quote }}
          role: {{ .role | quote }}
          serviceAccountRef:
            name: {{ include "oneview-pagerduty-bridge.serviceAccountName" $ }}
        {{- end }}
        {{- else if eq .Values.externalSecrets.secretStore.vault.auth.method "token" }}
        {{- with .Values.externalSecrets.secretStore.vault.auth.token }}
        tokenSecretRef:
          name: {{ .secretRef.name | quote }}
          key: {{ .secretRef.key | quote }}
        {{- end }}
        {{- end }}
      {{- with .Values.externalSecrets.secretStore.vault.tls }}
      tls:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }} {{/* secretStore.enabled */}}

{{- if .Values.externalSecrets.externalSecret.enabled }}
---
{{- if semverCompare ">=1.31-0" $.Capabilities.KubeVersion.Version }}
apiVersion: external-secrets.io/v1
{{- else }}
apiVersion: external-secrets.io/v1beta1
{{- end }}
kind: ExternalSecret
metadata:
  name: {{ .Values.externalSecrets.externalSecret.name | default (printf "%s-external-secret" (include "oneview-pagerduty-bridge.fullname" .)) }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "oneview-pagerduty-bridge.labels" . | nindent 4 }}
    component: external-secrets
    {{- with .Values.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .Values.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  refreshInterval: {{ .Values.externalSecrets.externalSecret.refreshInterval | quote }}
  secretStoreRef:
    name: {{ .Values.externalSecrets.secretStore.name | default (printf "%s-secretstore" (include "oneview-pagerduty-bridge.fullname" .)) }}
    kind: SecretStore
  target:
    name: {{ .Values.externalSecrets.externalSecret.secretName | quote }}
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          {{- include "oneview-pagerduty-bridge.labels" . | nindent 10 }}
          source: vault
  data:
    {{- range .Values.externalSecrets.externalSecret.data }}
    - secretKey: {{ .secretKey | quote }}
      remoteRef:
        key: {{ .remoteRef.key | quote }}
        property: {{ .remoteRef.property | quote }}
    {{- end }}
{{- end }} {{/* externalSecret.enabled */}}
{{- end }} {{/* externalSecrets.enabled */}}